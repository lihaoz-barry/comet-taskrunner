# Overlay System Architecture

## Component Hierarchy

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AITask                                 â”‚
â”‚  (Automation Task with Overlay Integration)                  â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  _automation_sequence()                            â”‚     â”‚
â”‚  â”‚  â”œâ”€ show overlay                                   â”‚     â”‚
â”‚  â”‚  â”œâ”€ Step 1: Wait for initialization â”€â”¬â”€> update   â”‚     â”‚
â”‚  â”‚  â”œâ”€ Step 2: Activate window         â”œâ”€> update   â”‚     â”‚
â”‚  â”‚  â”œâ”€ Step 3: Find Assistant          â”œâ”€> update   â”‚     â”‚
â”‚  â”‚  â”œâ”€ Step 4: Click Assistant         â”œâ”€> update   â”‚     â”‚
â”‚  â”‚  â”œâ”€ Step 5: Find input box          â”œâ”€> update   â”‚     â”‚
â”‚  â”‚  â”œâ”€ Step 6: Input text              â”œâ”€> update   â”‚     â”‚
â”‚  â”‚  â””â”€ Step 7: Send instruction        â””â”€> update   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ creates & controls
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   StatusOverlay                               â”‚
â”‚  (Main Overlay Window - Tkinter)                             â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ OverlayConfig   â”‚  â”‚ KeyboardHandler  â”‚  â”‚ SystemTray  â”‚â”‚
â”‚  â”‚                 â”‚  â”‚                  â”‚  â”‚             â”‚â”‚
â”‚  â”‚ â€¢ Position      â”‚  â”‚ â€¢ ESC listener   â”‚  â”‚ â€¢ Icon      â”‚â”‚
â”‚  â”‚ â€¢ Opacity       â”‚  â”‚ â€¢ Cancel callbackâ”‚  â”‚ â€¢ Menu      â”‚â”‚
â”‚  â”‚ â€¢ Dimensions    â”‚  â”‚                  â”‚  â”‚ â€¢ Controls  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                               â”‚
â”‚  UI Components:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚ ðŸ¤– Title: COMET AUTOMATION     â”‚                         â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚                         â”‚
â”‚  â”‚ âš¡ Warning                      â”‚                         â”‚
â”‚  â”‚ ðŸ“ Step N/7                    â”‚                         â”‚
â”‚  â”‚ Current: ...                   â”‚                         â”‚
â”‚  â”‚ Next: ...                      â”‚                         â”‚
â”‚  â”‚ â±ï¸ Time: Xs                     â”‚                         â”‚
â”‚  â”‚ [Progress Bar] XX%             â”‚                         â”‚
â”‚  â”‚ ESC to cancel                  â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## Data Flow

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AITask    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. show()
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                              â”‚
       â”‚ 2. update_status()           â–¼
       â”‚    (step, desc, progress) â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  StatusOverlay   â”‚
       â”‚                            â”‚                  â”‚
       â”‚                            â”‚ [Tkinter Thread] â”‚
       â”‚                            â”‚  â€¢ Update UI     â”‚
       â”‚                            â”‚  â€¢ Update time   â”‚
       â”‚                            â”‚  â€¢ Listen ESC    â”‚
       â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                     â”‚
       â”‚ 3. close()                         â”‚ ESC pressed
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                     â”‚
       â”‚ 4. _cancel_task() <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚    (via callback)
       â”‚
       â””â”€> Task cancelled

## Thread Model

Main Thread                      Overlay Thread
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    â”‚                                 â”‚
    â”œâ”€ Create AITask                 â”‚
    â”‚                                 â”‚
    â”œâ”€ Initialize overlay             â”‚
    â”‚                                 â”‚
    â”œâ”€ Start automation               â”‚
    â”‚                                 â”‚
    â”œâ”€ overlay.show() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                                 â”œâ”€ Create Tk window
    â”‚                                 â”œâ”€ Start mainloop
    â”‚                                 â”œâ”€ Update loop (100ms)
    â”‚                                 â”‚
    â”œâ”€ Step 1 execution               â”‚
    â”œâ”€ update_status() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚  (thread-safe)                  â”œâ”€ Queue update
    â”‚                                 â”œâ”€ Apply changes
    â”‚                                 â”‚
    â”œâ”€ Step 2 execution               â”‚
    â”œâ”€ update_status() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                                 â”œâ”€ Update display
    â”‚                                 â”‚
    â”œâ”€ ... continue steps             â”‚
    â”‚                                 â”‚
    â”œâ”€ All steps complete             â”‚
    â”‚                                 â”‚
    â”œâ”€ overlay.close() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                                 â”œâ”€ Stop mainloop
    â”‚                                 â””â”€ Cleanup
    â”‚                                 
    â””â”€ Task complete

## Configuration Flow

User Input
    â”‚
    â”œâ”€ System Tray Menu
    â”‚      â”‚
    â”‚      â””â”€> Change Position
    â”‚              â”‚
    â–¼              â–¼
OverlayConfig.set_position()
    â”‚
    â”œâ”€> Update memory config
    â”‚
    â””â”€> Save to JSON file
            â”‚
            â””â”€> config/overlay_config.json
                    â”‚
                    â””â”€> Loaded on next run

## Error Handling Strategy

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Try to use feature                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€> Success â”€> Use feature
           â”‚
           â””â”€> Failure (ImportError, etc.)
                   â”‚
                   â”œâ”€> Log warning
                   â”‚
                   â”œâ”€> Set flag (e.g., PYSTRAY_AVAILABLE=False)
                   â”‚
                   â””â”€> Continue without feature
                           â”‚
                           â””â”€> Graceful degradation

Examples:
â€¢ pystray unavailable â†’ No system tray (overlay still works)
â€¢ keyboard unavailable â†’ No ESC cancel (overlay still works)
â€¢ Tkinter unavailable â†’ Overlay disabled (automation still works)

## File Dependencies

src/tasks/ai_task.py
    â”‚
    â””â”€> imports src/overlay
            â”‚
            â”œâ”€> overlay_config.py
            â”‚       â””â”€> (no dependencies)
            â”‚
            â”œâ”€> status_overlay.py
            â”‚       â”œâ”€> tkinter (built-in)
            â”‚       â”œâ”€> overlay_config.py
            â”‚       â””â”€> keyboard_handler.py
            â”‚
            â”œâ”€> keyboard_handler.py
            â”‚       â””â”€> keyboard (optional)
            â”‚
            â””â”€> system_tray.py
                    â”œâ”€> pystray (optional)
                    â”œâ”€> PIL/Pillow
                    â””â”€> overlay_config.py

## Initialization Sequence

1. AITask.__init__()
   â””â”€> StatusOverlay() created
       â””â”€> OverlayConfig() loaded
           â””â”€> Read config/overlay_config.json (or use defaults)

2. AITask.execute()
   â””â”€> Start automation thread
       â””â”€> _automation_sequence()
           â””â”€> overlay.show()
               â”œâ”€> Create Tkinter window
               â”œâ”€> Start keyboard listener
               â””â”€> Start update loop

3. During automation
   â””â”€> _update_overlay_step(N)
       â””â”€> overlay.update_status(...)
           â””â”€> Thread-safe state update

4. Completion
   â””â”€> overlay.close()
       â”œâ”€> Stop keyboard listener
       â”œâ”€> Close Tkinter window
       â””â”€> Cleanup resources

## Memory & Performance

Memory Usage:
â”œâ”€ Tkinter window: ~5-10 MB
â”œâ”€ Status data: < 1 MB
â”œâ”€ Configuration: < 1 KB
â””â”€ Total: ~10-20 MB

CPU Usage:
â”œâ”€ Update loop (100ms): < 1%
â”œâ”€ Tkinter rendering: < 1%
â””â”€ Total: Negligible (< 1%)

Update Frequency:
â”œâ”€ Status updates: On-demand (per step)
â”œâ”€ Time display: Every 100ms
â””â”€ Progress bar: Every 100ms

## Security Considerations

âœ… No network communication
âœ… No sensitive data storage
âœ… No elevated privileges required (core features)
âœ… Graceful handling of permission errors
âœ… No arbitrary code execution
âœ… Configuration validated on load
âœ… Exception handling prevents crashes

âš ï¸ Optional features may require:
   â€¢ keyboard module: May need admin on some systems
   â€¢ pystray: Requires GTK on Linux
