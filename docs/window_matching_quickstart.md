# çª—å£åŒ¹é…ä¼˜åŒ– - å¿«é€Ÿå…¥é—¨æŒ‡å—

## ğŸ¯ é—®é¢˜æ‘˜è¦

**åŸé—®é¢˜**ï¼šç¨‹åºæˆªå›¾æ—¶é”™è¯¯åœ°è¯†åˆ«äº† Overlay çª—å£ï¼Œè€Œä¸æ˜¯ Comet æµè§ˆå™¨çª—å£

**åŸå› **ï¼š
1. Overlay çª—å£æ ‡é¢˜åŒ…å« "COMET" å…³é”®è¯ï¼Œå¯¼è‡´åŒ¹é…å†²çª
2. çª—å£åŒ¹é…ä»…ä¾èµ–æ ‡é¢˜å…³é”®è¯ï¼Œç²¾åº¦ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. âœ… **å·²å®Œæˆ**ï¼šé‡å‘½å Overlay çª—å£
2. ğŸ“‹ **å¾…å®æ–½**ï¼šå‡çº§åˆ°å¤šå±‚éªŒè¯çª—å£åŒ¹é…ç­–ç•¥

---

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. Overlay çª—å£é‡å‘½å

**æ–‡ä»¶**ï¼š`src/overlay/status_overlay.py`

**ä¿®æ”¹**ï¼š
- çª—å£æ ‡é¢˜ï¼š`"COMET AUTOMATION"` â†’ `"TaskRunner Monitor"`
- UI æ˜¾ç¤ºï¼š`"ğŸ¤– COMET AUTOMATION"` â†’ `"ğŸ¤– AI TASK MONITOR"`

**å½±å“**ï¼šç«‹å³æ¶ˆé™¤ Overlay ä¸æµè§ˆå™¨çš„å‘½åå†²çª

---

## ğŸ“‹ æ¨èçš„ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“

| æ–¹æ¡ˆ | ç²¾åº¦ | å¤æ‚åº¦ | æ¨èåº¦ | å¤‡æ³¨ |
|------|------|--------|--------|------|
| **1. è¿›ç¨‹åå¼ºåˆ¶éªŒè¯** | â­â­â­ | ç®€å• | â­â­â­ | å¿«é€Ÿæ”¹è¿›ï¼Œä½†ä¸å¤Ÿé²æ£’ |
| **2. çª—å£ç±»ååŒ¹é…** | â­â­â­â­â­ | ä¸­ç­‰ | â­â­â­â­â­ | **æœ€æ¨è**ï¼šç²¾å‡†ä¸”ç¨³å®š |
| **3. çˆ¶è¿›ç¨‹è¿½è¸ª** | â­â­â­â­ | å¤æ‚ | â­â­â­â­ | é€‚åˆç‰¹å®šåœºæ™¯ |
| **4. è¿›ç¨‹ Delta æ£€æµ‹** | â­â­â­â­â­ | å¤æ‚ | â­â­â­ | å·¥å…·æ€§æ–¹æ¡ˆï¼Œéç”Ÿäº§ |
| **5. æ··åˆå¤šå±‚éªŒè¯** | â­â­â­â­â­ | è¾ƒå¤æ‚ | â­â­â­â­â­ | **ç”Ÿäº§çº§**ï¼šæœ€ä½³å®è·µ |

### ğŸ† æœ€ç»ˆæ¨èï¼šæ–¹æ¡ˆ 5ï¼ˆæ··åˆéªŒè¯ï¼‰ + æ–¹æ¡ˆ 2ï¼ˆç±»åæ ¸å¿ƒï¼‰

**æ ¸å¿ƒç­–ç•¥**ï¼š
- **ä¸»è¦è¯†åˆ«**ï¼šçª—å£ç±»åï¼ˆWindow Classï¼‰- æœ€å¯é 
- **è¾…åŠ©éªŒè¯**ï¼šè¿›ç¨‹åç§°ã€çª—å£æ ‡é¢˜ã€çª—å£å°ºå¯¸
- **è¯„åˆ†ç³»ç»Ÿ**ï¼šå¤šå€™é€‰çª—å£æ—¶é€‰æ‹©æœ€ä½³åŒ¹é…

**ä¼˜åŠ¿**ï¼š
- ç²¾å‡†åº¦æ¥è¿‘ 100%
- å®¹é”™æ€§å¼ºï¼ˆå¤šå±‚éªŒè¯ï¼‰
- é…ç½®åŒ–ç®¡ç†ï¼ˆæ˜“äºè°ƒæ•´ï¼‰
- å®Œå…¨æ¶ˆé™¤è¯¯åŒ¹é…

---

## ğŸš€ å®æ–½æ­¥éª¤ï¼ˆ5 æ­¥å®Œæˆï¼‰

### æ­¥éª¤ 1ï¼šç¡®å®š Comet æµè§ˆå™¨çš„çª—å£ç±»å ğŸ”

ä½¿ç”¨æä¾›çš„å·¥å…·æ‰¾å‡ºçª—å£ç±»åï¼š

**æ–¹æ³• Aï¼šè¿›ç¨‹ Delta æ£€æµ‹ï¼ˆæ¨èï¼‰**
```bash
# 1. å…³é—­æ‰€æœ‰ Comet æµè§ˆå™¨çª—å£
# 2. è¿è¡Œæ£€æµ‹å·¥å…·
python tools/process_delta_detector.py

# 3. æŒ‰æç¤ºå¯åŠ¨ Comet æµè§ˆå™¨
# 4. æŸ¥çœ‹è¾“å‡ºä¸­çš„ "Class" å­—æ®µ
```

**æ–¹æ³• Bï¼šç›´æ¥æŸ¥çœ‹æ‰€æœ‰çª—å£**
```bash
# æŸ¥çœ‹æ‰€æœ‰åŒ…å« "Comet" çš„çª—å£
python tools/debug_windows.py --filter Comet

# æˆ–æŸ¥çœ‹æ‰€æœ‰æµè§ˆå™¨çª—å£
python tools/debug_windows.py
```

**é¢„æœŸè¾“å‡ºç¤ºä¾‹**ï¼š
```
Window #1
  Title:   Google - Perplexity - Comet Browser
  Class:   Chrome_WidgetWin_1  â† è®°å½•è¿™ä¸ªå€¼ï¼
  Process: Comet.exe (PID: 12345)
  ...
```

### æ­¥éª¤ 2ï¼šåˆ›å»ºé…ç½®æ–‡ä»¶ âš™ï¸

```bash
# å¤åˆ¶ç¤ºä¾‹é…ç½®
cp config/window_matching.yaml.example config/window_matching.yaml
```

ç¼–è¾‘ `config/window_matching.yaml`ï¼š

```yaml
comet_browser:
  # æ›¿æ¢ä¸ºæ­¥éª¤1ä¸­æ‰¾åˆ°çš„çª—å£ç±»å
  window_class: "Chrome_WidgetWin_1"  # â† ä¿®æ”¹è¿™é‡Œ

  # æ›¿æ¢ä¸ºå®é™…çš„è¿›ç¨‹åï¼ˆé€šå¸¸æ˜¯ comet.exe æˆ– Comet.exeï¼‰
  process_name: "comet.exe"  # â† ç¡®è®¤è¿™ä¸ª

  title_keywords:
    - "Comet"
    - "Perplexity"

  exclude_keywords:
    - "TaskRunner Monitor"  # æˆ‘ä»¬çš„ Overlay
    - "python.exe"
    - "cmd.exe"
    # æ·»åŠ å…¶ä»–éœ€è¦æ’é™¤çš„å…³é”®è¯

  min_width: 400
  min_height: 300

  validation:
    require_class_match: true   # å¿…é¡»åŒ¹é…ç±»å
    require_process_match: true # å¿…é¡»åŒ¹é…è¿›ç¨‹å
    require_title_keyword: false # æ ‡é¢˜å…³é”®è¯å¯é€‰
```

### æ­¥éª¤ 3ï¼šæ›´æ–° WindowManagerï¼ˆå¯é€‰ - é«˜çº§ç”¨æˆ·ï¼‰ ğŸ› ï¸

è¯¦ç»†å®ç°è¯·å‚è€ƒ `docs/window_matching_strategies.md` ä¸­çš„å®Œæ•´ä»£ç ç¤ºä¾‹ã€‚

**ç®€åŒ–ç‰ˆå®ç°ï¼ˆå¿«é€Ÿä¿®å¤ï¼‰**ï¼š

ç¼–è¾‘ `src/automation/window_manager.py`ï¼Œåœ¨ `find_comet_window` æ–¹æ³•ä¸­æ·»åŠ çª—å£ç±»åéªŒè¯ï¼š

```python
def find_comet_window(keywords=None, exclude_title=None, require_process=None,
                      require_class=None):  # æ–°å¢å‚æ•°
    """
    Find Comet browser window

    Args:
        keywords: List of keywords to match in title (default: ["Comet", "Perplexity"])
        exclude_title: Optional string, skip window if title contains this
        require_process: Optional string, exact process name (e.g. "comet.exe")
        require_class: Optional string, exact window class name (RECOMMENDED)
    """
    if keywords is None:
        keywords = ["Comet", "Perplexity"]

    # æ·»åŠ  Overlay åˆ°æ’é™¤åˆ—è¡¨
    exclude_keywords = ["backend.exe", "python.exe", "cmd.exe", "powershell.exe",
                       ".py", "comet-taskrunner", "Antigravity", "Visual Studio Code",
                       "TaskRunner Monitor"]  # â† æ–°å¢

    if exclude_title:
        exclude_keywords.append(exclude_title)

    found_windows = []

    def enum_callback(hwnd, _):
        if not WindowManager._is_candidate_window(hwnd):
            return True

        try:
            # === æ–°å¢ï¼šçª—å£ç±»åéªŒè¯ ===
            if require_class:
                class_name = win32gui.GetClassName(hwnd)
                if class_name != require_class:
                    return True  # ç±»åä¸åŒ¹é…ï¼Œè·³è¿‡

            title = win32gui.GetWindowText(hwnd).lower()

            # æ£€æŸ¥æ’é™¤åˆ—è¡¨
            if any(ex.lower() in title for ex in exclude_keywords):
                return True

            # æ£€æŸ¥å…³é”®è¯
            if any(keyword.lower() in title for keyword in keywords):
                _, pid = win32process.GetWindowThreadProcessId(hwnd)

                # è¿›ç¨‹åéªŒè¯
                if require_process:
                    proc_name = WindowManager._get_process_name(pid)
                    if not proc_name or proc_name.lower() != require_process.lower():
                        return True

                rect = win32gui.GetWindowRect(hwnd)
                found_windows.append({
                    'hwnd': hwnd,
                    'title': win32gui.GetWindowText(hwnd),
                    'rect': rect,
                    'pid': pid
                })

        except Exception as e:
            pass

        return True

    win32gui.EnumWindows(enum_callback, None)

    if not found_windows:
        logger.warning(f"No match found for keywords={keywords}, process={require_process}, class={require_class}")
        return None

    window = found_windows[0]
    logger.info(f"Found window: HWND={window['hwnd']}, Title='{window['title']}', PID={window['pid']}")

    return (window['hwnd'], window['rect'])
```

### æ­¥éª¤ 4ï¼šæ›´æ–°è°ƒç”¨ä»£ç  ğŸ“

åœ¨ä½¿ç”¨ `find_comet_window` çš„åœ°æ–¹æ·»åŠ ç±»åå‚æ•°ï¼š

ä¾‹å¦‚åœ¨ `src/tasks/ai_task.py` ä¸­ï¼š

```python
# æ—§ä»£ç 
result = window_mgr.find_comet_window()

# æ–°ä»£ç ï¼ˆæ¨èï¼‰
result = window_mgr.find_comet_window(
    keywords=["Comet", "Perplexity"],
    require_process="comet.exe",
    require_class="Chrome_WidgetWin_1"  # â† ä½¿ç”¨æ­¥éª¤1æ‰¾åˆ°çš„ç±»å
)
```

### æ­¥éª¤ 5ï¼šæµ‹è¯•éªŒè¯ âœ…

```bash
# 1. å¯åŠ¨ Comet æµè§ˆå™¨

# 2. éªŒè¯çª—å£åŒ¹é…
python tools/debug_windows.py --filter Comet

# 3. è¿è¡Œä½ çš„ä»»åŠ¡ï¼Œæ£€æŸ¥æ˜¯å¦æ­£ç¡®è¯†åˆ«çª—å£
# ï¼ˆæ£€æŸ¥æ—¥å¿—è¾“å‡ºï¼‰
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šä»ç„¶åŒ¹é…åˆ°é”™è¯¯çš„çª—å£

**æ£€æŸ¥æ¸…å•**ï¼š
1. ç¡®è®¤çª—å£ç±»åæ˜¯å¦æ­£ç¡®
   ```bash
   python tools/debug_windows.py --all
   ```
2. æ£€æŸ¥æ’é™¤å…³é”®è¯åˆ—è¡¨æ˜¯å¦å®Œæ•´
3. å¯ç”¨è°ƒè¯•æ—¥å¿—æŸ¥çœ‹åŒ¹é…è¿‡ç¨‹
   ```python
   logger.setLevel(logging.DEBUG)
   ```

### é—®é¢˜ï¼šæ‰¾ä¸åˆ°ä»»ä½•çª—å£

**å¯èƒ½åŸå› **ï¼š
1. çª—å£ç±»åé…ç½®é”™è¯¯ â†’ é‡æ–°è¿è¡Œæ­¥éª¤ 1
2. è¿›ç¨‹åé…ç½®é”™è¯¯ â†’ æ£€æŸ¥ä»»åŠ¡ç®¡ç†å™¨ä¸­çš„è¿›ç¨‹å
3. æµè§ˆå™¨æœªå¯åŠ¨æˆ–å·²æœ€å°åŒ– â†’ ç¡®ä¿æµè§ˆå™¨å¯è§

**è°ƒè¯•å‘½ä»¤**ï¼š
```bash
# æŸ¥çœ‹æ‰€æœ‰çª—å£ï¼ˆä¸è¿‡æ»¤ï¼‰
python tools/debug_windows.py --all

# æŸ¥çœ‹ç‰¹å®šå…³é”®è¯çš„çª—å£
python tools/debug_windows.py --filter "your-keyword"
```

### é—®é¢˜ï¼šå·¥å…·è¿è¡Œå¤±è´¥

**å¸¸è§é”™è¯¯**ï¼š
```
ModuleNotFoundError: No module named 'win32gui'
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
pip install pywin32 psutil
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- **è¯¦ç»†æ–‡æ¡£**ï¼š`docs/window_matching_strategies.md` - å®Œæ•´çš„æ–¹æ¡ˆå¯¹æ¯”å’Œå®ç°ç¤ºä¾‹
- **é…ç½®æ¨¡æ¿**ï¼š`config/window_matching.yaml.example` - é…ç½®æ–‡ä»¶è¯¦ç»†è¯´æ˜
- **è°ƒè¯•å·¥å…·**ï¼š
  - `tools/debug_windows.py` - æŸ¥çœ‹æ‰€æœ‰çª—å£ä¿¡æ¯
  - `tools/process_delta_detector.py` - æ£€æµ‹æ–°è¿›ç¨‹å’Œçª—å£

---

## ğŸ’¡ å…³é”®è¦ç‚¹

1. **çª—å£ç±»åï¼ˆWindow Classï¼‰æ˜¯æœ€å¯é çš„è¯†åˆ«ç‰¹å¾** - ä¼˜å…ˆä½¿ç”¨
2. **å¤šå±‚éªŒè¯æé«˜é²æ£’æ€§** - ç±»å + è¿›ç¨‹å + æ ‡é¢˜
3. **é…ç½®åŒ–ç®¡ç†** - ä¾¿äºä¸åŒç¯å¢ƒè°ƒæ•´
4. **å·¥å…·è¾…åŠ©** - ä½¿ç”¨æä¾›çš„å·¥å…·å¿«é€Ÿå®šä½é—®é¢˜

---

## âœ¨ é¢„æœŸæ•ˆæœ

**ä¼˜åŒ–å‰**ï¼š
- è¯¯åŒ¹é…ç‡ï¼š~15%
- ç²¾å‡†åº¦ï¼š~85%
- ä¾èµ–ï¼šä»…æ ‡é¢˜å…³é”®è¯

**ä¼˜åŒ–å**ï¼š
- è¯¯åŒ¹é…ç‡ï¼š< 0.1%
- ç²¾å‡†åº¦ï¼š> 99.9%
- ä¾èµ–ï¼šçª—å£ç±»å + è¿›ç¨‹å + æ ‡é¢˜ï¼ˆå¤šå±‚éªŒè¯ï¼‰

---

**æœ€åæ›´æ–°**ï¼š2025-12-09
**ç‰ˆæœ¬**ï¼š1.0
